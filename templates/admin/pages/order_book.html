<div class="card">
    <div class="card-header"></div>
    <div class="card-body">
        <!-- order_book.html -->
        <div class="container">
            <!-- Symbol Selection -->
            <div class="symbol-selector">
                <select id="symbolSelect" onchange="window.location.href='?symbol='+this.value">
                    {% for s in symbols %}
                    <!-- <option value="{{ s }}" {% if s==symbol %}selected{% endif %}>{{ s }}</option> -->
                    {% endfor %}
                </select>
                <div class="ltp-display">
                    LTP: रु. {{ "%.2f"|format(ltp) }}
                </div>
            </div>
            <!-- Order Placement Form -->
            <div class="order-form">
                <form method="POST" action="{{ url_for('routes.place_order') }}">
                    <input type="hidden" name="symbol" value="{{ symbol }}">
                    <div class="form-group">
                        <label>Action:</label>
                        <select name="is_buy" required>
                            <option value="true">Buy</option>
                            <option value="false">Sell</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Price (रु. ):</label>
                        <!-- <input type="number" name="price" min="{{ "%.2f"|format(ltp * 0.98) }}" 
                    max="{{ "%.2f"|format(ltp * 1.02) }}" 
                    step="0.01" required> -->
                    </div>
                    <div class="form-group">
                        <label>Quantity:</label>
                        <input
                            type="number"
                            name="quantity"
                            min="1"
                            required
                        >
                    </div>
                    <button type="submit">Place Order</button>
                </form>
            </div>
            <!-- Order Book Tables -->
            <div class="order-book">
                <div class="buy-orders">
                    <h3>Buy Orders</h3>
                    <table>
                        <tr>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Orders</th>
                        </tr>
                        {% for o in buy_orders %}
                        <tr>
                            <td>रु. {{ "%.2f"|format(o.price) }}</td>
                            <td>{{ o.total_quantity }}</td>
                            <td>{{ o.order_count }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                <div class="sell-orders">
                    <h3>Sell Orders</h3>
                    <table>
                        <tr>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Orders</th>
                        </tr>
                        {% for o in sell_orders %}
                        <tr>
                            <td>रु. {{ "%.2f"|format(o.price) }}</td>
                            <td>{{ o.total_quantity }}</td>
                            <td>{{ o.order_count }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
            <!-- Holdings and Matched Orders -->
            <div class="user-data">
                <div class="holdings">
                    <h3>Your Holdings ({{ symbol }})</h3>
                    <p>Shares: {{ holdings.quantity if holdings else 0 }}</p>
                    <p>Collateral: रु. {{ "%.2f"|format(collateral) }}</p>
                </div>
                <div class="matched-orders">
                    <h3>Recent Trades</h3>
                    <table>
                        <tr>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Time</th>
                        </tr>
                        {% for mo in matched_orders %}
                        <tr>
                            <td>रु. {{ "%.2f"|format(mo.price) }}</td>
                            <td>{{ mo.quantity }}</td>
                            <td>{{ mo.timestamp.strftime('%H:%M:%S') }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
// order_book.html update
<script>
function fetchOrderBook() {
    fetch(`/page/order_book?symbol=${document.getElementById('symbolSelect').value}`)
        .then(r => r.json())
        .then(data => {
            // Update LTP and security name
            document.getElementById('ltp').innerHTML = 
                `LTP: ₹${data.ltp.toFixed(2)} (${getPercentageChange(data.ltp)}%)`;
            
            // Update buy/sell orders
            updateOrderTable('buy-orders', data.buy_orders);
            updateOrderTable('sell-orders', data.sell_orders);
        });
}

function getPercentageChange(ltp) {
    // Implement percentage change logic based on previous LTP
    return ((Math.random() * 2 - 1)).toFixed(2); // Example random change
}

function updateOrderTable(tableId, orders) {
    const table = document.getElementById(tableId);
    table.innerHTML = `<tr><th>Price</th><th>Qty</th><th>Orders</th></tr>`;
    
    // Ensure exactly 7 price levels
    for(let i=0; i<7; i++) {
        const order = orders[i] || {price: '-', quantity: '-', count: '-'};
        table.innerHTML += `
            <tr>
                <td>₹${order.price.toFixed(2) || '-'}</td>
                <td>${order.quantity || '-'}</td>
                <td>${order.count || '-'}</td>
            </tr>
        `;
    }
}

// Real-time updates
setInterval(fetchOrderBook, 5000);
fetchOrderBook();

// Order placement with AJAX
document.getElementById('orderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    fetch('/place_order', {
        method: 'POST',
        body: new FormData(this)
    }).then(r => {
        if(r.ok) fetchOrderBook(); // Refresh data after successful order
    });
});
</script>
